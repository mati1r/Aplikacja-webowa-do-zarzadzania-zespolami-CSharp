@page
@model Aplikacja_webowa_do_zarządzania_zespołami.Pages.MessagesModel
@{
    Layout = "_ComunicationLayout";
}
@if (Model.data == null)
{
    Response.Redirect("/");
}

<div class="w-100 h-100 d-inline-block overflow-auto bg-main">
    <div class="p-4">
        <h1 class="text-center display-6 fw-bold">Wiadomości</h1>
    </div>

    <div class="p-3">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card bg-table">
                        <div class="col-5 p-3">
                            <button class="btn btn-dark px-3 me-2" id="recive">Odebrane</button>
                            <button class="btn btn-dark px-3 me-2" id="send">Wysłane</button>
                            <button class="btn btn-primary px-3" id="create">Nowa wiadomość</button>
                        </div>
                        <div id="messageContainer">
                            <partial name ="Partials/_PartialReciveMessagesView" model="Model.reciveMessagesList"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        $(document).ready(function () {

            //Set how many records need to loaded after clicking on button
            let howMany = 20;

            //Button handlers
            $("#recive").click(function () {

                //Since we are changin content of the page we need to restart value of howMany
                howMany = 20;

                if ($("#messageContainer").children().length > 0) {
                    $("#messageContainer").empty();
                }

                $.ajax({
                    type: 'get',
                    url: '@Url.Page("Messages", "ReciveMessagesView")',
                    data: { howMany: 10 }, //Get 10 records as in the begining
                    success: function (partialResult) {
                        $("#messageContainer").append(partialResult);
                    }
                });
            });

            $("#send").click(function () {

                //Since we are changin content of the page we need to restart value of howMany
                howMany = 20;

                if ($("#messageContainer").children().length > 0) {
                    $("#messageContainer").empty();
                }

                $.ajax({
                    type: 'get',
                    url: '@Url.Page("Messages", "SendedMessagesView")',
                    data: { howMany: 10 }, //Get 10 records as in the begining
                    success: function (partialResult) {
                        $("#messageContainer").append(partialResult);
                    }
                });
            });

            //loadMore handlers
            $("#messageContainer").on("click", "#loadMoreRecived", function () {

                //Clear space for new data
                if ($("#messageContainer").children().length > 0) {
                    $("#messageContainer").empty();
                }

                $.ajax({
                    type: 'get',
                    url: '@Url.Page("Messages", "ReciveMessagesView")', //Set url to handle its basicly the same as Messages?handler=MessagesView
                    data: { howMany: howMany }, //Set data to send in that case update value of howMany messages have to be loaded
                    success: function (partialResult) {
                        $("#messageContainer").append(partialResult);
                        howMany += 10;
                    }
                });
            });

            $("#messageContainer").on("click", "#loadMoreSended", function () {

                //Clear space for new data
                if ($("#messageContainer").children().length > 0) {
                    $("#messageContainer").empty();
                }

                $.ajax({
                    type: 'get',
                    url: '@Url.Page("Messages", "SendedMessagesView")', //Set url to handle its basicly the same as Messages?handler=MessagesView
                    data: { howMany: howMany }, //Set data to send in that case update value of howMany messages have to be loaded
                    success: function (partialResult) {
                        $("#messageContainer").append(partialResult);
                        howMany += 10;
                    }
                });
            });


            //On item click handlers
            $("#messageContainer").on("click", ".recive-item", function () {
                var newDiv = $('<div></div>', {
                    class: 'message',
                });

                if ($(this).hasClass("active")) {
                    $(this).removeClass("active");
                    let nextNewDiv = $(this).find(".message");
                    nextNewDiv.remove();
                } else {
                    $(this).append(newDiv);
                    $(this).addClass("active");
                    let idValue = $(this).attr("id");
                    let partial = $(this).find(".message");

                    partial.load('/Messages?handler=ReciveMessage&id=' + idValue);
                }
            });

            $("#messageContainer").on("click", ".sended-item", function () {
                var newDiv = $('<div></div>', {
                    class: 'message',
                });

                if ($(this).hasClass("active")) {
                    $(this).removeClass("active");
                    let nextNewDiv = $(this).find(".message");
                    nextNewDiv.remove();
                } else {
                    $(this).append(newDiv);
                    $(this).addClass("active");
                    let idValue = $(this).attr("id");
                    let partial = $(this).find(".message");

                    partial.load('/Messages?handler=SendedMessage&id=' + idValue);
                }
            });
        });

    </script>
}